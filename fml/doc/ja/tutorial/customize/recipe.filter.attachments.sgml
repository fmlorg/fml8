<!--
   $FML: recipe.filter.spamassassin.sgml,v 1.3 2004/10/06 09:07:35 fukachan Exp $
-->


<qandaentry>

<question>
<para>
危ない添付ファイルがついてきたメールは拒否する HOOK
</para>
</question>

<answer>

<para>
HOOK でなんとかする/ごまかす例は次の通りです。fml8 は、あらかじめ入力
されたメッセージを解析し、鎖状の Mail::Message オブジェクトの形で持っ
ています。そこで、MIME/Multipart の各部分のヘッダを取り出して、正規表
現で順に確認すればよいだけです。
</para>

<para>
昔の fml8 (2004/12/08 以前)なら、こんな感じ。
<screen>
$distribute_verify_request_start_hook = q{
    my $msg = $curproc->incoming_message() || undef;
    for (my $m = $msg; $m ; $m = $m->{ next } ) {
	my $hs = $m->message_fields() || '';
	if ($hs =~ /filename=.*\.(com|vbs|vbe|wsh|wse|js|exe|doc|rtf)/o) {
	    $curproc->log("attachment \.$1 found");
	    $curproc->stop_this_process();
	}
    }
};
</screen>
2004/12/08 以降なら、こんなかんじ。
<screen>
$distribute_verify_request_start_hook = q{
    my $msg  = $curproc->incoming_message() || undef;
    my $list = $msg->message_chain_as_array_ref();
    for my $m (@$list) {
	my $hs = $m->message_fields() || '';
	if ($hs =~ /filename=.*\.(com|vbs|vbe|wsh|wse|js|exe|doc|rtf)/o) {
	    $curproc->log("[new] attachment \.$1 found");
	    $curproc->stop_this_process();
	}
    }
};
</screen>
</para>

</answer>

</qandaentry>


