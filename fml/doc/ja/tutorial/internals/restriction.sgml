<!--
   $FML: restriction.sgml,v 1.7 2003/04/15 14:51:41 fukachan Exp $
-->


<chapter id="restriction">
	<title>
	入力データへの制限
	</title>

<para>
入力データ(特にコマンドなど)は FML::Restriction::CGI クラスが提供する
正規表現で検査します。
</para>


<sect1 id="restriction.overview">
	<title>
	入力の検査についての概要
	</title>

<sect2>
	<title>
	投稿
	</title>

<para>
FML::Restriction クラスによる入力データチェックはありませんが、
FML::Filter クラスによるフィルタチェックがデフォルトで適用されます。フィ
ルタをはずすには、config.cf で
<screen>
use_article_body_filter		=	no
</screen>
を設定して下さい。
</para>

</sect2>


<sect2>
	<title>
	コマンドメール
	</title>

<para>
コマンドメールは FML::Process::Command の中で一行ずつ
FML::Restriction::Command で定義されている正規表現にしたがって
検査されます。検査に合格すれば、
FML::Command::{User,Admin}::コマンド の実行に進むことができます。
</para>

</sect2>


<sect2>
	<title>
	CGI
	</title>

<para>
CGI の各プログラムでは、safe_param_ほえほえ() という関数経由でのみデー
タを受けとることができます。
</para>

<para>
safe_param_*()
および
try_cgi_*() 
は安全な値を返すことになっています。
</para>

<para>
これらの safe_param_XXX() は FML::Restriction::CGI (
FML::Restriction::Base を継承している)経由でパターンの検査をしています。
</para>

</sect2>


<sect2>
	<title>
	makefml および fml
	</title>

<para>
コマンドラインで実行するので、「入力チェックなし」がデフォルトです。
そのシェルが取れる時点で認証されているはずなので、
正しいユーザ/そのユーザのすることは正しいと信じています。
</para>

<para>
もちろん、各モジュールごとの制限は受けます。
たとえば、adduser でアドレスを追加しようとしても、
正しいアドレスに見えないような文字列を入れれば拒否されます。
このあたりの制限は各モジュール依存です。
</para>

</sect2>

</sect1>


<sect1 id="restriction.class">
	<title>
	FML::Restriction クラス
	</title>

<para>
入力データや、
コマンドの ACL は
FML::Restriction クラス以下にモジュールを配置することにしています。
</para>

<para>
例えば、CGI では
FML::Restriction::CGI クラスのモジュールを用いて
入力データがある正規表現の中に収まるかどうか？の検査をしています。
</para>

<para>
FML::Restriction 以下では Base を継承していますが、他のモジュールでは、
FML::Restriction クラスを object composition して使って下さい。例えば、
<screen>
use FML::Restriction::CGI;
$safe = new FML::Restriction::CGI;
my $allowed_regexp = $safe->param_regexp();

if ($value =~ /^$allowed_regexp{$key}$) { ... ok, do something ... ;}
</screen>
のように使います。
</para>

</sect1>


<sect1 id="restrictioncgi.input.data">
	<title>
	CGI における入力データの制限
	</title>

<para>
CGI では FML::Restriction::CGI クラスのモジュールを用いて
入力データがある正規表現の中に収まるかどうか？の検査をします。
</para>

<para>
入力値は、前述のクラスの入力制限をうけるべきです。
そのため、直接 param() を使ってはいけません。
必ず safe_param_xxx() メソッドを通じて、
param() ( CGI モジュール )からのデータ入力をして下さい。
</para>

<para>
なお、入力されたキーワード一覧を調べるために、
<screen>
for my $dirty_buf (param()) {
   ... check ...
}
</screen>
のような構文は許す必要はあるでしょうが、
<screen>
param($dirtty_buf)
</screen>
などとはしてはいけません。必ず
<screen>
for my $key (param()) {
   ... check ...

   if (key eq $key) {
       value = safe_param_key()
   }
}
</screen>
のように書いて下さい。
</para>

</sect1>


<sect1>
	<title>
	議論; FML::Restriction の制限はきびし過ぎる？
	</title>

<para>
FML::Restriction のクラスでは RFC などで許されている表現のごく一部だけ
を許しています。
</para>

<para>
RFC の定義が広すぎるんで…手抜きといえば手抜きといわれちゃいますが、
安全側に倒しています。
</para>

<para>
FML::Restriction::Command はコマンドのシンタックスチェックはもうちょっ
と粒度を上げるべきなのかもしれませんが、現状ではしていません。
</para>

</sect1>


</chapter>
