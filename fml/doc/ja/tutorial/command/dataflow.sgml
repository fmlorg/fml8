<!--
   $FML: dataflow.sgml,v 1.5 2005/06/25 15:11:28 fukachan Exp $
-->


<sect1 id="fml.command.dataflow">
	<title>
	コマンドの処理のフロー
	</title>


<!--
  <graphic entityref="image.command.dataflow"></graphic>
-->

<para>
すべての処理は最終的に「FML::Command」クラス経由で「FML::Command::モー
ド::コマンド」クラスを呼び出します。GUI および CUI、コマンドメールは、
そこに至る前処理の段階が異なるだけです。
</para>


<sect2>
	<title>
	コマンドメールの処理
	</title>

<caution>
<para>
2004/03/05 以降は、新しいフレームワークとなりました。
</para>
</caution>

<para>
まず、コマンドは行単位で、解析されます。
</para>

<para>
空行を無視するなどの基本的な処理の後、コマンド(行の先頭の文字列)が、現
在のコンテキストで許されるコマンドか否か？を確認します。
</para>

<para>
1) guideやsubscribeのようにメンバー以外にも許されるコマンドであれば、
   直接コマンド呼び出しルーチンへ処理が移ります。
   ここで許されるコマンドは anonymous_command_mail_allowed_commands
   で定義されているコマンドです。
</para>

<para>
2) メンバーだけに許されるコマンドの場合、
   command_mail_restrictionsのルールに従って他の条件を確認し、
   許されたなら、呼び出しルーチンへ処理が移ります。
   ここで許されるコマンドは user_command_mail_allowed_commands
   で定義されているコマンドです。
</para>

<para>
「呼び出しルーチン」では、
(コマンドに依存した)返事の送り先の確認と
(コマンドに依存する)シンタックスチェックを経て、
FML::Command クラス経由でコマンドが実行されます。
この実行は一般ユーザ権限で実行されます。
</para>

<para>
admin コマンドの実行は、ここでは行なわれません。「admin ...」コマンド
は、まず一般ユーザ権限の admin コマンド
<footnote>
<para>
注: admin コマンドは user_command_mail_allowed_commands で許されています
</para>
</footnote>
として処理が進められ、最終的に「FML::Command::User::admin」クラスが呼
び出されます。このクラスの中で、$admin_command_mail_restrictions に基
づいてリモート権限があるか？が確認され、もう一度「FML::Command」クラス
経由で管理者権限の「FML::Command::Admin::コマンド」クラスが呼び出され
ます(つまりトランポリンメカニズムです)。
</para>

</sect2>


<sect2>
	<title>
	CUI (makefml/fml)の処理
	</title>

<para>
このプログラムを使える時点で管理者権限(ＭＬのサーバにリモートで入り、
ユーザ fml に su できる権限)があるはずです。よって、特別な制限はありま
せん。FML::Command経由で「FML::Command::Admin::コマンド」クラスを直接
呼び出しています。
</para>

<para>
なお、サーバにリモートで入れるようにする際、SSH で「RSA 2048 bit 鍵の
み許す」といった設定および運用ルールにしてください。
</para>

</sect2>


</sect1>
